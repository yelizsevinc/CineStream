@page "/platforms/{PlatformId}/users"
@page "/platforms/{PlatformId}"
@using Microsoft.EntityFrameworkCore
@using CineStream.Data

@inject IDbContextFactory<CineStreamContext> DbFactory

<PageTitle>Users</PageTitle>

@if ((appPlatform != null) && (appPlatform.Name != null))
{
    <h1><i class="bi bi-people-fill" aria-hidden="true"></i> Users of @appPlatform.Name</h1>
}

@if (appUsers != null)
{
    <Datagrid Items="appUsers">
    <DatagridColumn Title="UserId" TRowData="AppUser" Field="c => c.UserId.ToString()" CanSort="true" CanFilter="true"
        FilterImmediately="true" />
    <DatagridColumn Title="Username" TRowData="AppUser" Field="c => c.Username" CanSort="true" CanFilter="true"
        FilterImmediately="true" />
    <DatagridColumn Title="Email" TRowData="AppUser" Field="c => c.Email" CanSort="true" CanFilter="true"
        FilterImmediately="true" />
    <DatagridColumn Title="SubscriptionDate" TRowData="AppUser" Field="c => c.SubscriptionDate.ToString()"
        CanSort="true" CanFilter="true" FilterImmediately="true" />
</Datagrid>
}

@code
{
    [Parameter]
    public string? PlatformId { get; set; }
    private Platform? appPlatform { get; set; }
    private ICollection<PlatformUser>? appPlatformUsers { get; set; }
    private ICollection<AppUser>? appUsers { get; set; }
    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        using var context = DbFactory.CreateDbContext();

        appUsers = new List<AppUser>();
        appPlatform = await context.Platforms!.FirstOrDefaultAsync(c => c.PlatformId.ToString() == PlatformId);

        var allPlatformUsers = await context.PlatformUsers!.ToListAsync();
        var platformUsers = allPlatformUsers.Where(c => c.PlatformId.ToString() == PlatformId).ToList();
        var allUsers = await context.Users!.ToListAsync();
        appPlatformUsers = allPlatformUsers.Where(c => c.PlatformId.ToString() == PlatformId).ToList();


        foreach (var platformUser in appPlatformUsers)
        {
            var user = await context.Users!.FirstOrDefaultAsync(u => u.UserId == platformUser.UserId);
            if (user != null)
            {
                var appUser = new AppUser
                    {
                        UserId = user.UserId,
                        Username = user.Username,
                        Email = user.Email,
                        SubscriptionDate = platformUser.SubscriptionDate
                    };
                appUsers.Add(appUser);
            }
        }

    }

}
